<% content_for :title, "Sale ##{ @sale.id }" %>

<div class="md:w-2/3 w-full">
  <% if notice.present? %>
    <p id="notice" class="py-2 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-md inline-block">
      <%= notice %>
    </p>
  <% end %>

  <h1 class="font-bold text-3xl mb-3">Venta <span class="text-gray-600">#<%= @sale.id %></span></h1>

  <div class="border rounded p-4 bg-white mb-4">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <p class="text-sm text-gray-500">Fecha</p>
        <p class="font-medium"><%= l(@sale.sold_at, format: :long) if @sale.sold_at %></p>
      </div>

      <div>
        <p class="text-sm text-gray-500">Cliente</p>
        <p class="font-medium"><%= @sale.client&.name || "—" %></p>
      </div>

      <div>
        <p class="text-sm text-gray-500">Vendedor</p>
        <p class="font-medium"><%= @sale.user&.name || "—" %></p>
      </div>

      <div>
        <p class="text-sm text-gray-500">Estado</p>
        <% if @sale.cancelled_at.present? %>
          <p class="font-medium text-red-600">Cancelada el <%= l(@sale.cancelled_at, format: :short) %></p>
        <% else %>
          <p class="font-medium text-green-600">Activa</p>
        <% end %>
      </div>
    </div>

    <hr class="my-4">

    <h2 class="font-semibold mb-2">Productos</h2>
    <div class="space-y-2">
      <% @sale.item_sales.each do |item| %>
        <div class="flex justify-between items-center border rounded px-3 py-2 bg-gray-50">
          <div>
            <p class="font-medium"><%= item.product&.name || "Producto eliminado" %></p>
            <p class="text-sm text-gray-500">Precio unitario: <%= number_to_currency(item.unit_price) %> · Cantidad: <%= item.quantity %></p>
          </div>
          <div class="text-right">
            <p class="font-medium"><%= number_to_currency(item.unit_price.to_f * item.quantity.to_i) %></p>
          </div>
        </div>
      <% end %>
    </div>

    <div class="mt-4 text-right">
      <p class="text-sm text-gray-500">Total</p>
      <p class="text-xl font-bold"><%= number_to_currency(@sale.total_amount) %></p>
    </div>
  </div>

  <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-2">
    <%= link_to "Volver al listado", sales_path,
        class: "w-full sm:w-auto text-center rounded-md px-3.5 py-2.5 bg-gray-100 hover:bg-gray-50 inline-block font-medium mb-2 sm:mb-0" %>

    <% unless @sale.cancelled_at.present? %>
      <%= button_to "Cancelar venta",
          cancel_sale_path(@sale),
          method: :patch,
          form_class: "w-full sm:inline-block",
          class: "w-full rounded-md px-3.5 py-2.5 text-white bg-yellow-600 hover:bg-yellow-500 font-medium cursor-pointer mb-2 sm:mb-0",
          data: { turbo_confirm: "¿Estás seguro que querés cancelar esta venta? Esto restaurará el stock." } %>
    <% else %>
      <span class="inline-block px-3.5 py-2.5 text-sm text-red-600 font-medium">Venta cancelada</span>
    <% end %>

    <% if @sale.cancelled_at.present? %>
      <p class="text-red-600 font-semibold">Esta venta fue cancelada. No se puede generar factura.</p>
    <% else %>
      <%= link_to "Descargar factura (PDF)",
              invoice_sale_path(@sale, format: :pdf),
              class: "btn btn-primary" %>
    <% end %>
</div>
